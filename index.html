<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="https://lirp-cdn.multiscreensite.com/1c46be22/dms3rep/multi/opt/logo-640w.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
      direction:rtl;
      align-items: center;  
      background-image: url('https://raw.githubusercontent.com/sellersinvoice/SheetForm/main/image2.jpg');
      background-size:auto;
    }

    h1, h3 {
      text-align: center;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      background-color: lightgrey;
      background:rgba(225, 224, 224, 0.8);
      color: black;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap; /* Allows items to wrap on smaller screens */
    }

    .form-group {
      flex: 1;
      min-width: 150px; /* Ensures inputs don't shrink too small */
      margin: 10px;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }

    .button-primary {
      background-color: #686f68;
      color: white;
      border: none;
      margin: 5px;
    }

    .button-secondary {
      background-color: #81a1bc;
      color: white;
      border: none;
      margin: 5px;
    }

    .button-secondary:hover, .button-primary:hover {
      opacity: 0.9;
    }

    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      overflow: auto;
      
    }

    .popup-content {
      background: #fff;
      background:rgba(225, 224, 224, 10);
      color: black;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .popup-content h4 {
      text-align: center;
      margin-bottom: 10px;
    }

    .popup-style, .popup-color, .popup-amount,.select-style {
      width: 100%;
      padding: 10px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    .style-row,.style-row1 {
      display: flex;
      gap: 10px;
      flex-wrap: wrap; /* Ensures rows adapt to smaller screens */
    }

    .style-row input, .style-row select ,.style-row1 input,.style-row1 select ,.style-row1 textarea{
      flex: 1;
      min-width: 100px; /* Prevents inputs from shrinking too much */
    }

    .remove-btn {
      background-color: #f44336;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px;
      border-radius: 5px;
      width: auto;
      font-size: 14px;
      margin: 5px;
    }

    .book-entry {
      background: #f1f1f1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap; /* Wraps on smaller screens */
    }

    .book-entry .order-details {
      flex-grow: 1;
      margin-bottom: 10px; /* Adds spacing when wrapping */
    }

    .book-entry .buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .submit-btn {
      display: block;
      width: 100%;
      background-color: #4CAF50;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      padding: 15px;
    }

    /* Responsive design for smaller screens */
    @media (max-width: 600px) {
      .form-row {
        flex-direction: column;
        gap: 10px;
      }

      .form-group {
        margin: 0;
      }

      .style-row .style-row1{
        flex-direction: column;
        gap: 10px;
      }

      .book-entry {
        flex-direction: column;
      }

      .book-entry .buttons {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h3>פורום הזמנות</h3>

    <!-- Customer Details Section -->
    <div class="form-section" id="customer-details-section">
      <div class="form-row">
        <div class="form-group">
          <label for="customer-name">שם</label>
          <input type="text" id="customer-name" placeholder="הזן שם">
        </div>
        <div class="form-group">
          <label for="customer-number">טלפון</label>
          <input type="text" id="customer-number" placeholder="הזן מספר טלפון">
        </div>
        <div class="form-group">
          <label for="customer-email">מייל</label>
          <input type="email" id="customer-email" placeholder="מייל">
        </div>
      </div>
    </div>

      <div class="form-row">
        <div class="form-group">
          <label for="delivery-date">תאריך אספקה</label>
          <input type="date" name="" id="delivery-date" class="select-style" onclick="this.showPicker();" >
        </div>
        <div class="form-group">
          <label for="book-supply">אספקת ספרים\בלוקים</label>
          <select name="book-supply" id="book-supply" class="select-style">
            <option value="" disabled selected>אספקת ספרים\בלוקים</option>
            <option value="ey-leather">אי ווי לדר</option>
            <option value="costumer">מזמין</option>
          </select>
          
        </div>
      </div>

    <!-- Book Orders Section -->
    <div class="form-section" id="book-orders-section">
      <h3>הזמנה</h3>
      <button type="button" class="button-primary" onclick="openPopup()">+ הוסף ספר</button>
      <div id="book-list"></div>
      <div class="style-row1">
      <textarea name="note" id="note" placeholder="הערות"class="select-style" ></textarea>
      </div>
    </div>
    <!-- Submit Button -->
    <button class="submit-btn" onclick="submitOrder()">שמור</button>
  </div>

  <!-- Add/Edit Popup -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <h4 id="popup-title">הוסף ספר</h4>
        <div class="style-row1">

            <input type="text" id="popup-book-name" class="select-style" placeholder="שם הספר">

              <select type="text" id="popup-book-size" class="select-style">
                <option value="" disabled selected>בחר גודל</option>
                <option value="S">S</option>
                <option value="S">M 17.5 ס"מ</option>
                <option value="S">L</option>
                <option value="S">XL</option>
              </select>

              <select type="text" id="popup-book-nusach" class="select-style">
                <option value="" disabled selected>בחר נוסח</option>
                <option value="ספרד">ספרד</option>
                <option value="אשכנז">אשכנז</option>
                <option value="עדות המזרח">ע"מ</option>
              </select>
        </div>
        <div style="display: flex; height: 3px;background-color: darkgray;"></div>
        <h4>בחר דוגמה וצבע</h4>
      <div id="style-rows">
        <div class="style-row">
          <select class="popup-color"></select>
          <select class="popup-style"></select>
          <input type="number" class="popup-amount" placeholder="כמות">
          <button type="button" class="remove-btn" onclick="removeRow(this)">הסר</button>
        </div>
      </div>
      <button type="button" class="button-secondary" onclick="addStyleRow()">+ הוסף דוגמה</button>
      <div class="style-row1">
        <input type="text" id="popup-book-ingrave" class="select-style" placeholder="שם להטבעה">
        <select type="text" id="popup-book-ingrave-select" class="select-style">
          <option value="" disabled selected>בחר סוג הטבעה</option>
          <option value="S">בלינד</option>
          <option value="S">בלינד שקוע</option>
          <option value="S">זהב</option>
        </select>
        <textarea name="book-note" id="book-note" placeholder="הערה" class="select-style"></textarea>
      </div>
      <div style="display: flex; height: 3px;background-color: darkgray; margin: 3px;"></div>

      <div style="margin-top: 20px;display: flex;">
        <button type="button" class="button-primary" onclick="saveBook()">שמור</button>
        <button type="button" class="button-secondary" onclick="closePopup()">ביטול</button>
      </div>
    </div>
  </div>

  <script>
    const books = [];
    let editIndex = null;
    let colors = [];
    let styles = [];

    function populateDropdowns(row) {
      const colorDropdown = row.querySelector('.popup-color');
      const styleDropdown = row.querySelector('.popup-style');
      colorDropdown.innerHTML = '';
      styleDropdown.innerHTML = '';

      colors.forEach(color => {
        const option = document.createElement('option');
        option.value = color;
        option.textContent = color;
        colorDropdown.appendChild(option);
      });

      styles.forEach(style => {
        const option = document.createElement('option');
        option.value = style;
        option.textContent = style;
        styleDropdown.appendChild(option);
      });
    }

    function addStyleRow() {
      const styleRows = document.getElementById('style-rows');
      const row = document.createElement('div');
      row.classList.add('style-row');
      row.innerHTML = `
        <select class="popup-color"></select>
        <select class="popup-style"></select>
        <input type="number" class="popup-amount" placeholder="כמות">
        <button type="button" class="remove-btn" onclick="removeRow(this)">הסר</button>
      `;
      styleRows.appendChild(row);
      populateDropdowns(row);
    }

    function removeRow(button) {
      button.parentElement.remove();
    }

    function openPopup(editMode = false, index = null) {
      const popup = document.getElementById('popup');
      const title = document.getElementById('popup-title');
      const styleRows = document.getElementById('style-rows');

      if (editMode) {
        title.textContent = 'Edit Book';
        const book = books[index];
        document.getElementById('popup-book-name').value = book.name;
        document.getElementById('popup-book-size').selectedIndex = parseInt(books[index].size[1]);
        document.getElementById('popup-book-nusach').selectedIndex = parseInt(books[index].nusach[1]);
        document.getElementById('popup-book-ingrave').value = books[index].ingrave[0];
        document.getElementById('popup-book-ingrave-select').selectedIndex = parseInt(books[index].ingrave[2]);
        document.getElementById('book-note').value = book.bookNote;

        styleRows.innerHTML = '';
        book.styles.forEach(style => {
          addStyleRow();
          const lastRow = styleRows.lastChild;
          lastRow.querySelector('.popup-color').value = style.color;
          lastRow.querySelector('.popup-style').value = style.style;
          lastRow.querySelector('.popup-amount').value = style.amount;
        });

        editIndex = index;
      } else {
        title.textContent = 'הוסף ספר';
        document.getElementById('popup-book-name').value = '';
        document.getElementById('popup-book-size').selectedIndex =0
        document.getElementById('popup-book-nusach').selectedIndex =0
        document.getElementById('popup-book-ingrave').value ='';
        document.getElementById('popup-book-ingrave-select').selectedIndex =0;
        document.getElementById('book-note').value =''

        styleRows.innerHTML = '';
        addStyleRow();
        editIndex = null;
        document.getElementById('popup-book-name').focus();
      }

      popup.style.display = 'flex';
    }

    function closePopup() {
      document.getElementById('popup').style.display = 'none';
    }

    function saveBook() {
      const name = document.getElementById('popup-book-name').value;
      const size = document.getElementById('popup-book-size').value;
      let sizeIndex = document.getElementById('popup-book-size').selectedIndex;
      const nusach = document.getElementById('popup-book-nusach').value;
      let nusahcIndex = document.getElementById('popup-book-nusach').selectedIndex;
      let nameIngrave = document.getElementById('popup-book-ingrave').value;
      let nameIngraveType = document.getElementById('popup-book-ingrave-select').value;
      let nameIngraveTypeIndex = document.getElementById('popup-book-ingrave-select').selectedIndex;
      let bookNote = document.getElementById('book-note').value
      
      const styleRows = document.querySelectorAll('.style-row');
      const styles = Array.from(styleRows).map(row => ({
        color: row.querySelector('.popup-color').value,
        style: row.querySelector('.popup-style').value,
        amount: row.querySelector('.popup-amount').value
      }));

      if (!name || styles.some(s => !s.color || !s.style || !s.amount)) {
        alert('נא למלאות כל השדות.');
        return;
      }

      if (editIndex !== null) {
        books[editIndex] = { name,size:[size,sizeIndex],nusach:[nusach,nusahcIndex], styles,bookNote:bookNote,ingrave:[nameIngrave,nameIngraveType,nameIngraveTypeIndex] };
      } else {
        books.push({ name,size:[size,sizeIndex],nusach:[nusach,nusahcIndex], styles,bookNote:bookNote,ingrave:[nameIngrave,nameIngraveType,nameIngraveTypeIndex] });
      }

      closePopup();
      updateBookList();
    }

    function updateBookList() {
      const bookList = document.getElementById('book-list');
      bookList.innerHTML = '';

      books.forEach((book, index) => {
        const bookDiv = document.createElement('div');
        bookDiv.classList.add('book-entry');
        const stylesText = book.styles
          .map(s => `<span style="direction: rtl;"><div><strong> צבע:</strong>${s.color},</div><div><strong>דוגמה:</strong>${s.style},</div><div><strong>כמות:</strong>${s.amount}</div></span>`)
          .join(', ');
        bookDiv.innerHTML = `
          <div class="order-details">
            <p><strong>${book.name}</strong><div style="display:flex;">${stylesText}</div></p>
          </div>
          <div class="buttons">
            <button onclick="openPopup(true, ${index})">ערוך</button>
            <button onclick="deleteBook(${index})">מחק</button>
          </div>
        `;
        bookList.appendChild(bookDiv);
      });
    }

    function deleteBook(index) {
      books.splice(index, 1);
      updateBookList();
    }

    
  async function submitOrder() {
    // Step 1: Collect the customer details
    const customerDetails = {
      name: document.getElementById('customer-name').value,
      number: document.getElementById('customer-number').value,
      email: document.getElementById('customer-email').value,
      note: document.getElementById('note').value,
      delivery: document.getElementById('delivery-date').value,
      bookSupply: document.getElementById('book-supply').value
    };

    // Validate customer details
    if (!customerDetails.name || !customerDetails.number || !customerDetails.email) {
      alert("נא למלא את כל פרטי הלקוח.");
      return;
    }

    // Step 2: Collect book orders
    const order = books.map(book => ({
      name: book.name,
      styles: book.styles.map(style => ({
        color: style.color,
        style: style.style,
        amount: style.amount,
      })),
    }));

    // Step 3: Prepare the data for submission
    const data = {
      customer: JSON.stringify(customerDetails),
      order: JSON.stringify(order),
    };

    // Step 4: Send the data using URLSearchParams
    let url = "https://script.google.com/macros/s/AKfycbw7Jd5EE6VhUA8UUBSiIjlJoX6egzbVa9iJkGPp3xWjYAlCJEuTgBGz-Hav2d03ss7kXQ/exec";

    try {
      const params = new URLSearchParams(data);

      const response = await fetch(url, {
        method: "POST",
        body: params, // Send as URL-encoded payload
      });

      const result = await response.json(); // Parse the JSON response

      if (result.status === "success") {
        alert("ההזמנה נשלחה בהצלחה!");
        document.getElementById('customer-name').value = '';
      document.getElementById('customer-number').value = '';
      document.getElementById('customer-email').value = '';
      document.getElementById('note').value = '';
      document.getElementById('book-supply').selectedIndex=0;
      document.getElementById('delivery-date').value = '';


      // Clear the book list
      books.length = 0;
      updateBookList();  // Refresh the book list UI
      } else {
        alert("שגיאה בעת שליחת ההזמנה: " + result.message);
      }
    } catch (error) {
      console.error("Error submitting order:", error);
      alert("שגיאה בעת שליחת ההזמנה. נסה שוב מאוחר יותר.");
    }
  }

  </script>
  <script>
    let webAppURL = "https://script.google.com/macros/s/AKfycbw7Jd5EE6VhUA8UUBSiIjlJoX6egzbVa9iJkGPp3xWjYAlCJEuTgBGz-Hav2d03ss7kXQ/exec";

// Fetch data and display it in a table
 fetch(webAppURL)
  .then(response => response.json())
  .then(data => {
    if (data.status === "success") {

       styles = data.data[1];
       colors = data.data[0];

    } else {
      alert("Failed to fetch data from Google Sheets.");
    }
  })
  .catch(error => {
    console.error("Error fetching data:", error);
    alert("Error fetching data from the web app.");
  });
  window.onload = () => {
      document.getElementById('customer-name').focus();
    };
  </script>
</body>
</html>
